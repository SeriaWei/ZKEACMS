/*!
 * http://www.zkea.net/
 * Copyright 2018 ZKEASOFT
 * http://www.zkea.net/licenses
 */
tinymce.PluginManager.add("imagelocal",function(n){function t(){tinymce.activeEditor.windowManager.confirm("确定要将外链图片迁移到您的服务器吗？这可能会花一些时间。",function(t){if(t){tinyMCE.activeEditor.setProgressState(!0);var u=n.getContent(),i=[],r={},u=$("<div>"+n.getContent()+"<\/div>");$("img",u).each(function(){var n=$(this).attr("src");n&&(n.indexOf(".qpic.cn/")>0&&n.indexOf("tp=webp")>0&&(n=n.split("?")[0]),n.indexOf("/")!=0&&n.replace("http://","").replace("https://","").indexOf(window.location.hostname)!=0&&(i.indexOf(n)?(i.push(n),r[n]=[$(this)]):r[n].push($(this))))});i.length>0?$.post("/admin/Media/DownLoadExternalImage",{images:i},function(t){var f,e;if(t){for(f=0;f<t.length;f++)if(r[t[f].key])for(e=0;e<r[t[f].key].length;e++)r[t[f].key][e].attr("src",t[f].value);n.setContent(u.html());tinyMCE.activeEditor.setProgressState(!1)}i.length!=t.length?tinymce.activeEditor.windowManager.alert("部分图片没有下载成功，可从日志中查看原因或重试。"):tinymce.activeEditor.windowManager.alert("图片迁移成功")},"json"):(tinyMCE.activeEditor.setProgressState(!1),tinymce.activeEditor.windowManager.alert("没有发现外链图片"))}})}n.ui.registry.addButton("imagelocal",{icon:"upload",tooltip:"转存外链图",onAction:t})});