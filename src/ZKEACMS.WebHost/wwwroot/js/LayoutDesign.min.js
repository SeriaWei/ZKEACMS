$(function(){var e=$("#containers");if(e.children().size()>0&&0===e.children(".container").size()&&0===e.children(".container-fluid").size()){var t=$('<div class="container"></div>');e.children().appendTo(t),e.append(t)}var a=['<div class="tools">','<i class="glyphicon glyphicon-resize-horizontal" title="拉伸"></i>','<i class="glyphicon glyphicon-resize-small" title="居中"></i>','<i class="glyphicon glyphicon-sort" title="拖动排序"></i>','<i class="glyphicon glyphicon-erase custom-style-editor" title="编辑样式"></i>','<i class="glyphicon glyphicon-remove-circle" title="删除"></i>',"</div>"].join(""),n=['<div class="tools">','<i class="glyphicon glyphicon-remove-circle" title="删除"></i>',"</div>"].join(""),o=['<div class="tools">','<i class="glyphicon glyphicon-menu-left" title="宽度 - 1"></i>','<i class="glyphicon glyphicon glyphicon-menu-right" title="宽度 + 1"></i>','<i class="glyphicon glyphicon-remove-circle" title="删除"></i>',"</div>"].join("");function i(){var e=$('<div class="additional zone"></div>'),t=$("<zone></zone>");return t.append('<input class="form-control" type="text" name="ZoneName" placeholder="输入名称" value="区域 '+($("#containers input[type=text]").size()+1)+'" />'),t.append('<input class="form-control" type="hidden" name="LayoutId" value="'+$("#LayoutId").val()+'" />'),t.append('<input class="form-control" type="hidden" name="ID" value="" />'),t.append('<input class="form-control" type="hidden" name="HeadingCode" value="" />'),e.append(t),e}$(document).on("click","#toolBar .col-size a",function(){$("#add-col-handle").attr("data-val",$(this).data("val")).find(".col-size-info").text($(this).text()),$(this).parent().parent().find(".active").removeClass("active"),$(this).parent().addClass("active")}),$(".AddContainer").draggable({helper:"clone"}),$(".AddRow").draggable({helper:"clone",revert:"invalid",connectToSortable:".container,.container-fluid"}),$(".AddCol").draggable({helper:"clone",connectToSortable:".additional.row"}),$(".templates ul li").draggable({helper:"clone",connectToSortable:"#containers>div"});var l={placeholder:"additional",tolerance:"pointer",connectWith:".additional.row",over:function(e,t){t.item.hasClass("AddCol")?t.placeholder.addClass(t.item.data("col")+t.item.data("val")).html('<div class="colContent row muted"></div>'):t.placeholder.addClass(t.item.attr("class")).html('<div class="colContent row muted"></div>')},stop:function(e,t){if(t.item.hasClass("AddCol")){var a=$('<div class="additional '+t.item.data("col")+t.item.data("val")+' ui-sortable-handle">'+o+'<div class="colContent row"></div></div>');a.find(".colContent").append(i()),t.item.replaceWith(a)}}},s={placeholder:"additional row muted",tolerance:"pointer",connectWith:".container,.container-fluid",items:".additional.row",stop:function(e,t){var a=$('<div class="additional row">'+n+"</div>");if(t.item.hasClass("AddRow"))t.item.replaceWith(a);else if(t.item.data("add")){var s=$(t.item.find(".row").html());s.find(".border-helper").remove(),a.append(s),t.item.replaceWith(a),s.each(function(){$(this).addClass("additional"),$(this).append(o),$(this).append($('<div class="colContent row"></div>').append(i()))})}a.sortable(l)}};function r(){$("#containers").sortable({placeholder:"design",axis:"y",tolerance:"pointer",start:function(e,t){t.helper.hasClass("container")?(t.placeholder.addClass("container"),t.helper.css("left",t.placeholder.offset().left)):t.placeholder.addClass("container-fluid")},handle:".glyphicon-sort"}),$("#containers>div").sortable(s).append(a).addClass("design main custom-style"),$(".additional.row").sortable(l).append(n).children(".additional").append(o)}r(),$("body").droppable({greedy:!0,accept:".AddContainer",hoverClass:"dropWarning",drop:function(e,t){var n=$('<div class="container design main">'+a+"</div>");n.sortable(s),$(".additional.row",n).sortable(l),$("#containers").append(n)}}),$(document).on("click",".container.design .glyphicon-resize-horizontal",function(){$(this).closest(".container").removeClass("container").addClass("container-fluid")}),$(document).on("click",".container-fluid.design .glyphicon-resize-small",function(){$(this).closest(".container-fluid").removeClass("container-fluid").addClass("container")}),$(document).on("click","#containers .glyphicon-remove-circle",function(){var e=$(this).parent().parent();Easy.ShowMessageBox("提示","确定要删除吗？",function(){e.remove()},!0,10)}),$(document).on("click","#containers .glyphicon-menu-left",function(){var e=$(this).parent().parent().attr("class");e=e.replace(/col-md-(\d+)/g,function(e,t){return(t=parseInt(t))>1&&t--,"col-md-"+t}),$(this).parent().parent().attr("class",e)}),$(document).on("click","#containers .glyphicon-menu-right",function(){var e=$(this).parent().parent().attr("class");e=e.replace(/col-md-(\d+)/g,function(e,t){return(t=parseInt(t))<12&&t++,"col-md-"+t}),$(this).parent().parent().attr("class",e)}),$(document).on("click",".custom-style-editor",function(){$(".custom-style-target").removeClass("custom-style-target"),$(this).parents(".main").addClass("custom-style-target")}),$(window).width()>1600&&$(".templates").addClass("active"),$(document).on("click",".templates .tool-open",function(){$(this).parent().toggleClass("active")}),e.removeClass("hide"),$(document).on("click","#save",function(){if($('input[name="ZoneName"]').each(function(){$.trim($(this).val())||$(this).val("未命名"),$(this).attr("value",$(this).val())}),!$(this).data("done")){$(this).data("done",!0);var t=$("#LayoutInfo");$("zone").each(function(e){$("input",this).each(function(){$(this).attr("name","zones["+e+"]."+$(this).attr("name")).addClass("hide")}).appendTo(t)});var a=$('<div id="containers"/>').append(e.html());$("div",a).removeClass("ui-droppable").removeClass("ui-sortable").removeClass("ui-sortable-handle").removeClass("active").removeClass("design").removeClass("custom-style-target").not(".custom-style").removeAttr("style"),$(".tools",a).remove();for(var n=a.html().split("<zone>"),o=[],i=0;i<n.length;i++)o.push(n[i]),i<n.length-1&&o.push("<zone>");var l=[];for(i=0;i<o.length;i++)for(var s=o[i].split("</zone>"),r=0;r<s.length;r++)l.push(s[r]),r<s.length-1&&l.push("</zone>");$(".layout-html",t).remove();for(i=0;i<l.length;i++){var c=$.trim(l[i]);c&&t.append($('<textarea name="html" class="layout-html hide"></textarea>').val(c))}return t.submit(),!1}}),$(document).on("click","#show-source-code",function(){$('input[name="ZoneName"]').each(function(){$.trim($(this).val())||$(this).val("未命名"),$(this).attr("value",$(this).val())});var t=$('<div id="containers"/>').append(e.html());$("div",t).removeClass("ui-droppable").removeClass("ui-sortable").removeClass("ui-sortable-handle").removeClass("active").removeClass("design").removeClass("custom-style-target").not(".custom-style").removeAttr("style"),$(".tools",t).remove();var a=t.html().replace(new RegExp("><div","g"),">\n<div").replace(new RegExp("></div","g"),">\n</div").replace(new RegExp("><zone>","g"),">\n<zone>\n").replace(new RegExp("></zone","g"),">\n</zone").replace(new RegExp("><input","g"),">\n<input");c.setValue(a),setTimeout(function(){c.refresh();var e=c.lineCount();c.autoFormatRange({line:0,ch:0},{line:e})},500)}),$(document).on("click","#save-layout-code",function(){var t=c.getValue();e.html(t),$("input[name=LayoutId]",e).val($("#LayoutId").val()),r()});var c=CodeMirror.fromTextArea(document.getElementById("layout-code"),{lineNumbers:!0,mode:"htmlmixed",theme:"monokai",lineWrapping:!0,autofocus:!0,tabSize:2,extraKeys:{"Ctrl-J":"autocomplete"},autoCloseTags:!0});$(".CodeMirror").height($(window).height()-220),$("#modal-layout-code").css("display","")});